<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Itinerary Finder</title>
    <script src="../js/jquery.min.js"></script>
    <style>
        body {
            font-family: "calibri";
            width: 800px;
            margin: 0 auto;
            border: solid;
            border-top:none;
            padding: 10px;
        }


        label,
        input,
        p,
        select {
            display: block;
            margin-bottom: 15px;
        }

    </style>
<script src="ItineraryProcessor.js" type="text/javascript"></script>
</head>

<body>
    <div id="form">
        <h1>Itinerary Finder</h1>
        <p>Find multiple tours that fit back-to-back within your travel dates.</p>
        <label for="">Depart After</label>
        <input id="start-date" type="date" />
        <label for="">Depart Within</label>
        <select id='depart-within'>
            <option value='7'>1 Week</option>
            <option value='14' selected>2 Weeks</option>
            <option value='21'>3 Weeks</option>
            <option value='28'>4 Weeks</option>
            <option value='56'>8 Weeks</option>
            <option value='84'>12 Weeks</option>
        </select>
        <label>Return Before</label>
        <input id="end-date" type="date">
        <label>Tour 1</label>
        <select id="tour-1"></select>
        <label>Tour 2</label>
        <select id="tour-2"></select>
        <label>Tour 3</label>
        <select id="tour-3"></select>
        <label>Tour 4</label>
        <select id="tour-4"></select>
        <label>Tour 5</label>
        <select id="tour-5"></select>
        <label>Minimum days between tours</label>
        <input id="min" type="number" value='2'>
        <label>Maximum days between tours</label>
        <input id="max" type="number" value='5'>
        <button>Search</button>
    </div>
    <div id="result">
    </div>
    <script defer>

        function setDefaultDateFields(){
            var sd = document.getElementById("start-date");
            var ed = document.getElementById("end-date");
            var sdDefault = new Date(Date.now()+30*24*3600*1000); // 30 days from now
            var edDefault = new Date(Date.now()+180*24*3600*1000); // 180 days from now
            var sdFormat = sdDefault.toISOString().split('T')[0];
            var edFormat = edDefault.toISOString().split('T')[0];
            sd.value = sdFormat;
            ed.value =edFormat;

        }


        function getTourIdsFromSelects(){
            var selects = document.querySelectorAll("select[id^='tour-']");
            var n = selects.length;
            var array = [];
            for(let i = 0; i < n; i++){
                if(selects[i].value !== "0"){
                    array.push(parseInt(selects[i].value));
                }
            }
            return array;
        }

        function getDataFromForm(){
            var sub = {};
            sub.start = document.getElementById("start-date").value;
            sub.window = document.getElementById("depart-within").value;
            sub.end = document.getElementById("end-date").value;
            sub.tours = getTourIdsFromSelects();
            sub.minInterval = document.getElementById("min").value;
            sub.maxInterval = document.getElementById("max").value;
            return sub;
        }

        function processFormSubmit() {
            var sub = getDataFromForm();
            var ip = new ItineraryProcessor();
            ip.setTourSequence(sub.tours);
            window.ip = ip;

            var callback = (data)=>{
                ip.receiveItineraryData(data);
            }

            $.post("../itineraries/find", sub, callback);
            sub.tours.forEach((id)=>getDepartureData(ip,id));
        }


        function createSelectOption(selectNode, value, text) {
            var opt = document.createElement("option");
            opt.setAttribute('value', value);
            opt.innerHTML = text;
            selectNode.appendChild(opt);
        }

        function addToAllSelects(value, text) {
            var n = selects.length;
            for (let i = 0; i < n; i++) {
                createSelectOption(selects[i], value, text);
            }
        }

        function handleTourData(data) {
            var n = data.length;
            for (let i = 0; i < n; i++) {
                addToAllSelects(data[i].tour_id, data[i].tour_name);
            }
        }

        function getDepartureData(ipObject, tourId){
            var callback =function(data){
                ipObject.receiveDepartureData(tourId,data);
            }
            $.get('../tour/'+tourId+'/departures',null,callback);
        }


        //End of defintions

        setDefaultDateFields();

        var btn = document.getElementsByTagName("button")[0];
        btn.addEventListener("click", processFormSubmit);

        var selects = document.querySelectorAll("select[id^='tour-']");
        addToAllSelects(0, "None");
        $.get("../report/tours", null, handleTourData);

    </script>

</body>

</html>
